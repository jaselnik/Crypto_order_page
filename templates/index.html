<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>Async Order</title>
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css" integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU" crossorigin="anonymous">
    <!-- Bootstrap core CSS -->
    <link href="{{ url_for('static', filename='css/bootstrap.min.css') }}" rel="stylesheet">
  </head>

  <body>
  <div class="container">
      <div class="row jumbotron">
        <div class="col">
            <div class="container">
            </div>
            <div class="row">
              <div class="col-4">
                <div class="list-group" id="list-tab" role="tablist">
                  <a class="list-group-item list-group-item-action active market" id="list-home-list" data-toggle="list" href="#list-home" role="tab" aria-controls="home">Market</a>
                  <a class="list-group-item list-group-item-action stop" id="list-profile-list" data-toggle="list" href="#list-profile" role="tab" aria-controls="profile">Stop</a>
                  <a class="list-group-item list-group-item-action limit" id="list-messages-list" data-toggle="list" href="#list-messages" role="tab" aria-controls="messages">Limit</a>
                </div>
                <br>
                <div class="container">
                   <a class="btn btn-sm btn-warning" id="rm-all-orders" role="button">Rm all orders</a>
                </div>
              </div>
              <div class="col-8">
                <div class="tab-content" id="nav-tabContent">
                  <div class="tab-pane fade show active" id="list-home" role="tabpanel" aria-labelledby="list-home-list">
                    <a class="btn btn-sm btn-primary market-order" side-data="buy" role="button">Buy </a>
                    <a class="btn btn-sm btn-danger market-order" side-data="sell" role="button">Sell</a>
                    {% from "_formhelpers.html" import market_order_detail_form %}
                    {{ market_order_detail_form('Market') }}
                  </div>
                  <div class="tab-pane fade" id="list-profile" role="tabpanel" aria-labelledby="list-profile-list">
                    <a class="btn btn-sm btn-primary stop-order" side-data="buy" role="button">Buy </a>
                    <a class="btn btn-sm btn-danger stop-order" side-data="sell" role="button">Sell</a>
                    {% from "_formhelpers.html" import order_detail_form %}
                    {{ order_detail_form('Stop') }}
                  </div>
                  <div class="tab-pane fade" id="list-messages" role="tabpanel" aria-labelledby="list-messages-list">
                    <a class="btn btn-sm btn-primary limit-order" role="button" side-data="buy">Buy </a>
                    <a class="btn btn-sm btn-danger limit-order" role="button" side-data="sell">Sell</a>
                    {% from "_formhelpers.html" import order_detail_form %}
                    {{ order_detail_form('Limit') }}
                  </div>
                </div>
              </div>
            </div>
            <div id="error-msg">
            <!--Here will be error data which is getting from socket-->
            </div>
        </div>
        <div class="col">
            {% from "_formhelpers.html" import render_add_client_field %}
            <form class="add-client-form" method="post" role="form">
              <dl>
                  {% for field in form %}
                      {{ render_add_client_field(field) }}
                  {% endfor %}
              </dl>
              <button type="submit" class="add-client btn-sm btn-primary" data-dismiss="modal">Add Client</button>
            </form>
        </div>
        <div class="w-100"></div>
      </div>
  </div>

  <div class="table-responsive-sm">
    <table class="table">
        <thead>
          <tr>
            <th scope="col">#</th>
            <th scope="col">balance</th>
            <th scope="col">order type</th>
            <th scope="col">symbol</th>
            <th scope="col">amount</th>
            <th scope="col">open</th>
            <th scope="col">side</th>
            <th scope="col">failed</th>
            <th scope="col">order_exist</th>

            <th scope="col">Limit order #1</th>
            <th scope="col">Limit order #2</th>
            <th scope="col">Limit order #3</th>

            <th scope="col">Stop order #1</th>
            <th scope="col">Stop order #2</th>
            <th scope="col">Stop order #3</th>
          </tr>
        </thead>
        <tbody class="client-table-body">
        <!--Here will be client data which is getting from socket-->
        </tbody>
    </table>
  </div>

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <script src="{{ url_for('static', filename='js/bootstrap.min.js') }}"></script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.6/socket.io.min.js"></script>
    <script type="text/javascript" charset="utf-8">
        $(document).ready(function() {
            var socket = io.connect(location.protocol + '//' + document.domain + ':' + location.port);
            socket.on('connect', function () {
                socket.emit('my event', {data: 'I\'m connected!'});
            });

            socket.on('my response', function (msg) {
                console.log(msg);
            });
            socket.on('data error', function (msg) {
               console.log(msg);
               var text = '<div class="alert alert-danger alert-dismissible fade show" role="alert">';
               text += '<button type="button" class="close" data-dismiss="alert" aria-label="Close">';
               text += '<span aria-hidden="true">&times;</span>';
               text += '</button>';
               text += '<strong>'+msg['income']+'!</strong> '+msg['msg'];
               text += '</div>';
               $("#error-msg").html(text);
            });
            socket.on('reload-table', function (msg) {
                console.log(msg);
                var data = msg['data'];
                var count = msg['count'];
                var clients_string = '';
                console.log(data);
                console.log(count);

                for (i = 0; i < count; i++) {
                    clients_string += '<tr>';
                    clients_string += '<th scope="row">' + i.toString() + '</th>';
                    clients_string += '<td>' + data[i]['data']["balance"].toString() + '</td>';
                    clients_string += '<td>' + data[i]['data']["order_type"] + '</td>';
                    clients_string += '<td>' + data[i]['data']["symbol"] + '</td>';
                    clients_string += '<td>' + data[i]['data']["amount"].toString() + '</td>';
                    clients_string += '<td>' + data[i]['data']["open"].toString() + '</td>';
                    clients_string += '<td>' + data[i]['data']["side"] + '</td>';
                    clients_string += '<td>' + data[i]['data']["failed"] + '</td>';
                    clients_string += '<td>' + data[i]['data']["order_exist"] + '</td>';
                    clients_string += '</tr>';
                }
                $(".client-table-body").html(clients_string);
            });
            $('.add-client').click(function (e) {
                socket.emit('add-client', {form: $('.add-client-form').serialize()});
                return false;
             });
            $('.market-order').click(function (e) {
                e.preventDefault();
                var side = $(this).attr('side-data');
                data = {
                    side: side,
                    type: 'Market',
                    price: $('#price-Market').val(),
                    amount: $('#amount-Market').val(),
                };
                socket.emit('market', data);
                return false;
            });
            $('.stop-order').click(function (e) {
                e.preventDefault();
                var side = $(this).attr('side-data');
                data = {
                    side: side,
                    type: 'Stop',
                    price: $('#price-Stop').val(),
                    amount: $('#amount-Stop').val(),
                };
                socket.emit('stop', data);
                return false;
            });
            $('.limit-order').click(function (e) {
                e.preventDefault();
                var side = $(this).attr('side-data');
                data = {
                    side: side,
                    type: 'Limit',
                    price: $('#price-Limit').val(),
                    amount: $('#amount-Limit').val(),
                };
                socket.emit('limit', data);
                return false;
            });
            $('#rm-all-orders').click(function (e) {
                e.preventDefault();
                socket.emit('rm-all-orders');
                return false;
            });
        });
    </script>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
  </body>
</html>
